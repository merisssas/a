name: MyXL Key Hunter (v3 - Smart Extract & Fallback)

on:
  workflow_dispatch:
    inputs:
      apk_url:
        description: 'Direct Link Download APK/APKM'
        required: true

jobs:
  hunt:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Setup Java 21
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install Tools (JADX 1.5.0 & Apktool)
        run: |
          # 1. Install JADX 1.5.0 (Terbaru)
          wget https://github.com/skylot/jadx/releases/download/v1.5.0/jadx-1.5.0.zip
          unzip -q jadx-1.5.0.zip -d jadx
          chmod +x jadx/bin/jadx
          
          # 2. Install Apktool (Plan B untuk XML)
          sudo apt-get update
          sudo apt-get install -y apktool

      - name: Smart Download & Prepare
        run: |
          echo "‚¨áÔ∏è Downloading..."
          wget -U "Mozilla/5.0" -O temp_download.zip "${{ inputs.apk_url }}"
          
          echo "üïµÔ∏è Menganalisa Isi File..."
          # Cek isi zip tanpa ekstrak
          unzip -l temp_download.zip > file_list.txt
          
          if grep -q "base.apk" file_list.txt; then
            echo "‚úÖ Tipe: APP BUNDLE (APKM/XAPK)"
            echo "   -> Mengambil base.apk..."
            unzip -p temp_download.zip base.apk > target_final.apk
            
          elif grep -q "classes.dex" file_list.txt; then
            echo "‚úÖ Tipe: STANDARD APK"
            echo "   -> Menggunakan file langsung..."
            mv temp_download.zip target_final.apk
            
          else
            echo "‚ö†Ô∏è Format tidak dikenal atau file korup!"
            echo "   -> Mencoba paksa rename ke .apk..."
            mv temp_download.zip target_final.apk
          fi
          
          echo "üìÇ Info File Target:"
          ls -lh target_final.apk
          file target_final.apk

      - name: Decompile (JADX)
        id: jadx_step
        continue-on-error: true
        run: |
          echo "üöÄ Memulai Decompile (Code & Resource)..."
          export JAVA_OPTS="-Xmx6g"
          
          # Gunakan log level error untuk mengurangi noise, tapi verbose jika crash
          ./jadx/bin/jadx -d out -r -s --no-debug-info --log-level error target_final.apk
          
          if [ -d "out/resources" ] || [ -d "out/sources" ]; then
            echo "‚úÖ JADX Sukses!"
          else
            echo "‚ùå JADX Gagal (Output folder kosong)."
            exit 1
          fi

      - name: Fallback Decompile (Apktool)
        if: steps.jadx_step.outcome == 'failure'
        run: |
          echo "‚ö†Ô∏è JADX Gagal. Mengaktifkan PLAN B: Apktool..."
          echo "   (Ini akan membongkar Resources untuk mencari Basic Auth)"
          
          # Decode resources only (-r di apktool kebalikan jadx, -s skip source)
          # Kita mau resources, jadi jangan skip resources.
          apktool d -f -o out_apktool target_final.apk
          
          # Pindahkan hasil apktool ke folder out/resources agar script python bisa baca
          mkdir -p out/resources
          # Copy strings.xml jika ada
          find out_apktool -name "strings.xml" -exec cp --parents {} out/resources/ \;
          echo "‚úÖ Apktool selesai."

      - name: Run Hunter Script
        run: |
          echo "üîç Memulai Pencarian Key..."
          if [ -d "out" ] || [ -d "out_apktool" ]; then
            # Kita arahkan script python ke folder yang ada isinya
            python hunt.py
          else
            echo "‚ùå Semua metode gagal. File APK mungkin rusak/terenkripsi."
            exit 1
          fi
