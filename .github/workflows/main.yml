name: Super Patcher (Reqable + Device Spoofer)

on:
  workflow_dispatch:
    inputs:
      apk_url:
        description: 'Link Direct Download APK Target'
        required: true
        type: string

jobs:
  inject-everything:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Environment
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
      
      - name: Setup Node.js (untuk apk-mitm)
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Tools
        run: |
          npm install -g apk-mitm
          wget "https://github.com/LSPosed/LSPatch/releases/download/v0.6/jar-v0.6-398-release.jar" -O lspatch.jar

      - name: Download Target APK
        run: |
          wget --content-disposition "${{ inputs.apk_url }}"
          # Rename file apapun yang didownload menjadi target.apk agar mudah diproses
          find . -maxdepth 1 -type f -name "*.apk" -not -name "lspatch.jar" -exec mv {} target.apk \;
          echo "Target APK siap."

      - name: Download Android Faker (Auto-Latest)
        run: |
          # Script ini otomatis mencari release terbaru dari Android Faker di GitHub
          # Android Faker dipilih karena fitur randomisasinya kuat
          LATEST_URL=$(curl -s https://api.github.com/repos/Android1500/AndroidFaker/releases/latest | grep "browser_download_url" | grep ".apk" | cut -d '"' -f 4)
          
          echo "Mendownload Android Faker dari: $LATEST_URL"
          wget "$LATEST_URL" -O module.apk

      - name: Tahap 1 - Patch Network (Reqable Support)
        run: |
          echo "Membuka Network Security Config..."
          # Ini membuat aplikasi percaya pada User Certificate (Reqable)
          apk-mitm target.apk --wait
          
          # apk-mitm akan menghasilkan file berakhiran -patched.apk
          mv *-patched.apk step1.apk

      - name: Tahap 2 - Inject Spoofer (LSPatch)
        run: |
          echo "Menyuntikkan Module Spoofing..."
          # Inject module.apk ke dalam step1.apk
          # -l (local) = module tertanam di dalam APK
          # -f (force) = timpa jika ada error
          java -jar lspatch.jar step1.apk -m module.apk -f -l
          
          # Rename hasil akhir
          mv step1-393-lspatch.apk final_app.apk || mv *-lspatch.apk final_app.apk

      - name: Upload Hasil Akhir
        uses: actions/upload-artifact@v4
        with:
          name: App-Sniff-Spoof-Ready
          path: final_app.apk
