name: MyXL V4 (TrustMeAlready + Clean Sign)

on:
  workflow_dispatch:
    inputs:
      apk_url:
        description: 'Direct Link Download MyXL (XAPK/APK)'
        required: true
        type: string

jobs:
  lspatch-process:
    runs-on: ubuntu-latest
    env:
      _JAVA_OPTIONS: "-Xmx4096m"

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Install Tools
        run: |
          # 1. LSPatch (Gunakan versi spesifik yang stabil)
          wget https://github.com/LSPosed/LSPatch/releases/download/v0.6/jar-v0.6-398-release.jar -O lspatch.jar

          # 2. Module: TrustMeAlready (Kita pakai ini lagi karena JustTrustMe terbukti CRASH)
          wget https://github.com/ViRb3/TrustMeAlready/releases/download/v1.11/TrustMeAlready-v1.11-release.apk -O module.apk

          # 3. APKEditor (Merge XAPK)
          wget https://github.com/REAndroid/APKEditor/releases/download/V1.4.0/APKEditor-1.4.0.jar -O APKEditor.jar

          # 4. Signer (Uber APK Signer)
          wget https://github.com/patrickfav/uber-apk-signer/releases/download/v1.3.0/uber-apk-signer-1.3.0.jar -O signer.jar
          
          # 5. Zip utility
          sudo apt-get update && sudo apt-get install -y zip

      - name: Download App
        run: |
          echo "Downloading..."
          wget "${{ inputs.apk_url }}" -O input_file
          
          if unzip -t input_file > /dev/null 2>&1; then
            echo "FILE_TYPE=XAPK" >> $GITHUB_ENV
            mv input_file raw.xapk
          else
            mv input_file raw.apk
            echo "FILE_TYPE=APK" >> $GITHUB_ENV
          fi

      - name: Merge XAPK (Clean Merge)
        if: env.FILE_TYPE == 'XAPK'
        run: |
          echo "Merging..."
          unzip raw.xapk -d extracted_xapk
          java -jar APKEditor.jar m -i extracted_xapk -o original.apk

      - name: Prepare APK
        if: env.FILE_TYPE == 'APK'
        run: mv raw.apk original.apk

      - name: Execute LSPatch (Inject Module)
        run: |
          echo "Patching..."
          mkdir -p output
          
          # Gunakan module TrustMeAlready
          # -f: Force overwrite
          java -jar lspatch.jar original.apk -m module.apk -f -o output
          
          # Cari file hasil patch (nama file output lspatch kadang berubah-ubah)
          find output -name "*.apk" -exec mv {} lspatched.apk \;

      - name: FINAL FIX (Clean & Re-Sign)
        run: |
          echo "Stripping old signature..."
          # Hapus folder META-INF sepenuhnya agar signer dipaksa bekerja dari nol
          # Ini memperbaiki masalah "already signed SKIP"
          zip -d lspatched.apk META-INF/\*
          
          echo "Signing with Debug Key..."
          # --overwrite: Timpa file lama
          # --allowResign: Izinkan sign ulang
          java -jar signer.jar --apks lspatched.apk --allowResign --overwrite --out .
          
          # Rename hasil akhir
          mv lspatched-aligned-debugSigned.apk MyXL-Mod-Final.apk

      - name: Upload Result
        uses: actions/upload-artifact@v4
        with:
          name: MyXL-Mod-Final
          path: MyXL-Mod-Final.apk
