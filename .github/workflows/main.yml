name: Super Patcher V14 (Split APKS Preservation Mode)

on:
  workflow_dispatch:
    inputs:
      apk_url:
        description: 'Link File (APKS / XAPK Only)'
        required: true
        type: string
        default: 'https://www.mediafire.com/file/lxciw8l36u045wn/Mnet+Plus_3.38.0.apk/file'

jobs:
  split-patch-mode:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Java (Temurin 17)
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
      
      - name: Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10' 

      - name: Install Tools
        run: |
          sudo apt-get update
          sudo apt-get install -y zipalign apksigner zip unzip
          
          # 1. Install APK-MITM
          npm install -g apk-mitm
          
          # 2. Download LSPatch
          wget "https://github.com/LSPosed/LSPatch/releases/download/v0.6/jar-v0.6-398-release.jar" -O lspatch.jar
          
          # 3. Download Uber APK Signer
          wget "https://github.com/patrickfav/uber-apk-signer/releases/download/v1.3.0/uber-apk-signer-1.3.0.jar" -O signer.jar
          
          pip install cloudscraper requests beautifulsoup4

      - name: Create Certificate (Reqable)
        run: |
          cat <<EOF > reqable.pem
          -----BEGIN CERTIFICATE-----
          MIIFETCCA/mgAwIBAgIUOkl2iSzmLNvVqAPLtLk5WxAWItAwDQYJKoZIhvcNAQEL
          BQAwgZUxCzAJBgNVBAYTAkNOMREwDwYDVQQIDAhTaGFuZ2hhaTERMA8GA1UEBwwI
          U2hhbmdoYWkxFTATBgNVBAoMDFJlcWFibGUsIExMQzFJMBsGA1UECwwUaHR0cHM6
          Ly9yZXFhYmxlLmNvbS8wKgYDVQQDDCNSZXFhYmxlIENBIChKYW4gMTUsIDIwMjYs
          IDBBQjIyQTI3KTAeFw0yNjAxMTUxMDAxMzJaFw0zMzA1MzEwNTU1NDZaMIGVMQsw
          CQYDVQQGEwJDTjERMA8GA1UECAwIU2hhbmdoYWkxETAPBgNVBAcMCFNoYW5naGFp
          MRUwEwYDVQQKDAxSZXFhYmxlLCBMTEMxSTAbBgNVBAsMFGh0dHBzOi8vcmVxYWJs
          ZS5jb20vMCoGA1UEAwwjUmVxYWJsZSBDQSAoSmFuIDE1LCAyMDI2LCAwQUIyMkEy
          NykwggEiMA0GCSqGSIb3DQEBAQUAA4IBDwAwggEKAoIBAQC9v7wn1vWtLg7bXddE
          CWC58lY+KDqtJINb7aOoObMMKL4sc68+KpTJVTwOsWCnrrLbzPvO5+LEKIOh10IP
          PBDTJBLU3t1OcaReQQic91Yl2MKsrFS9WbW4iRR+BeHtfRMaar+EB23aVMdwx1Uk
          WOlqt5hQaoRbUZnqpgaf+OS2PRHbMHyEPvd3e8pxMkI4V5uSBBdGpdObJuoWUUzf
          VKsgSVDDypbx3eNGKJtc04dZFi+DdGbpfynDgAyTliXbozRuvYOTi17KL1/aLM2K
          GGC1KKdFlXo7sELimlD3TZq7QCrCXdJduJ/qT+aIgrYV8ZIz0OpcXrXjBHhQwlmF
          JlgfAgMBAAGjggFVMIIBUTAdBgNVHQ4EFgQU8pGSM/80EVRYMbfHRefpv2lbZJYw
          HwYDVR0jBBgwFoAU8pGSM/80EVRYMbfHRefpv2lbZJYwDwYDVR0TAQH/BAUwAwEB
          /zAOBgNVHQ8BAf8EBAMCAgQwge0GCWCGSAGG+EIBDQSB3xaB3FRoaXMgUm9vdCBj
          ZXJ0aWZpY2F0ZSB3YXMgZ2VuZXJhdGVkIGJ5IFJlcWFibGUgUHJveHkgZm9yIFNT
          TCBQcm94eWluZy4gSWYgdGhpcyBjZXJ0aWZpY2F0ZSBpcyBwYXJ0IG9mIGEgY2Vy
          dGlmaWNhdGUgY2hhaW4sIHRoaXMgbWVhbnMgdGhhdCB5b3UncmUgYnJvd3Npbmcg
          dGhyb3VnaCBSZXFhYmxlIFByb3h5IHdpdGggU1NMIFByb3h5aW5nIGVuYWJsZWQg
          Zm9yIHRoaXMgd2Vic2l0ZS4wDQYJKoZIhvcNAQELBQADggEBAJBTF1a+EIfxOpi0
          PXhBbNq6LgSLEPFgFms6TByLmKOMgaFhkI74XttYUoe/JPnr7LNDGAZcvmGIv1nq
          5O8vvmzsq3R+moe3GfsU7XlpOnXerdXo0+aCe+KOM6emCqD7fwvKbBmjm54MsZwg
          rp3XQS1mGRirZBNkjKEtLFUdams223C98ohpue7b0CvVxEIfCzhGl4l4sKwOfMz1
          ioqA6JRC56mHKaN8uWO3vWzuEjHOdluWgRVDhtoWzf/V8LNbZHuO0G2nTQw4aNfo
          jTl712YOY5ljPgYFxjT41QEavk3/vY6gDKcX4xpZb0T2xa3QFY7cYjZcU990u66y
          Ff6Xjn0=
          -----END CERTIFICATE-----
          EOF

      - name: Download File
        shell: python
        env:
          APK_URL: ${{ inputs.apk_url }}
        run: |
          import cloudscraper
          import os
          import sys
          import re
          from bs4 import BeautifulSoup
          from urllib.parse import urlparse

          url = os.environ['APK_URL']
          scraper = cloudscraper.create_scraper(browser='chrome')

          # Default name
          filename = "download.apks" 

          print(f"üîó URL: {url}")
          
          # Scrape Mediafire Logic
          need_scrape = False
          if 'mediafire.com' in url:
              if 'download' in urlparse(url).netloc: need_scrape = False
              elif '/file/' in url: need_scrape = True
              else: need_scrape = True

          if need_scrape:
              try:
                  html = scraper.get(url).text
                  soup = BeautifulSoup(html, 'html.parser')
                  download_btn = soup.find('a', {'id': 'downloadButton'})
                  if download_btn and download_btn.get('href'):
                      url = download_btn.get('href')
                      if url.startswith('//'): url = 'https:' + url
                  else:
                      match = re.search(r'href="((https?:)?//download[^"]+)"', html)
                      if match:
                          url = match.group(1)
                          if url.startswith('//'): url = 'https:' + url
              except Exception as e:
                  print(str(e))
                  sys.exit(1)

          print(f"‚¨áÔ∏è Downloading to {filename}...")
          try:
              with scraper.get(url, stream=True, timeout=60) as r:
                  if r.status_code != 200: sys.exit(1)
                  with open(filename, 'wb') as f:
                      for chunk in r.iter_content(chunk_size=1024*1024): 
                          if chunk: f.write(chunk)
          except Exception as e:
              sys.exit(1)

      - name: Download Android Faker
        run: |
          wget "https://www.mediafire.com/file/32gssatb1p4pkbk/Android_Fakers.apk/file?dkey=1dxu0ul7601&r=1660" -O module.apk

      - name: Extract & Analyze Bundle
        run: |
          echo "üì¶ Membongkar APKS/XAPK..."
          unzip -q download.apks -d workspace
          
          echo "üîç Menganalisis Isi..."
          ls -R workspace
          
          if [ ! -f "workspace/base.apk" ]; then
             echo "‚ùå Error: Tidak ditemukan 'base.apk' di dalam bundle."
             echo "Pastikan link yang dimasukkan adalah XAPK atau APKS."
             exit 1
          fi

          # Cek kompabilitas 32-bit untuk Realme
          if ls workspace/config.armeabi_v7a.apk 1> /dev/null 2>&1 || ls workspace/split_config.armeabi_v7a.apk 1> /dev/null 2>&1; then
             echo "‚úÖ Berita Bagus: Bundle ini punya library 32-bit (armeabi-v7a)!"
             echo "‚úÖ Harusnya kompatibel dengan Realme Note 50 kamu."
          else
             echo "‚ö†Ô∏è PERINGATAN: Bundle ini sepertinya hanya 64-bit."
             echo "‚ö†Ô∏è Jika HP kamu 32-bit, instalasi mungkin masih akan gagal."
          fi

      - name: Patching Base APK (Network & Module)
        run: |
          cd workspace
          
          echo "üõ°Ô∏è Tahap 1: Patching Network (Reqable) pada base.apk..."
          apk-mitm base.apk --certificate ../reqable.pem
          
          # apk-mitm outputnya: base-patched.apk
          if [ ! -f "base-patched.apk" ]; then
             echo "‚ùå Gagal patch network!"
             exit 1
          fi
          
          echo "üíâ Tahap 2: Inject LSPatch pada base-patched.apk..."
          java -jar ../lspatch.jar base-patched.apk -m ../module.apk -f -l 2
          
          # LSPatch output: base-patched-lspatched.apk
          TARGET=$(find . -maxdepth 1 -name "*-lspatched.apk")
          
          if [ -z "$TARGET" ]; then
             echo "‚ùå Gagal inject LSPatch!"
             exit 1
          fi
          
          echo "üîÑ Mengganti base.apk asli dengan hasil patch..."
          mv "$TARGET" base.apk
          
          # Hapus file sisa patch
          rm base-patched.apk
          
          cd ..

      - name: Cleaning & Re-Signing ALL Splits
        run: |
          echo "üßπ Membersihkan signature lama dari SEMUA file APK di bundle..."
          # Kita harus menghapus META-INF dari semua apk (base, config, split, dll)
          # Agar nanti bisa ditandatangani ulang secara seragam.
          
          find workspace -name "*.apk" -print0 | xargs -0 -I {} zip -d {} "META-INF/*" || true
          
          echo "‚úçÔ∏è Menandatangani SEMUA APK dalam bundle..."
          # Uber APK Signer bisa sign satu folder sekaligus.
          # Ini penting! Semua split harus punya signature yang SAMA persis.
          java -jar signer.jar -d workspace --overwrite
          
          # Hapus file yang belum di-sign (karena --overwrite kadang membuat file baru jika nama beda)
          # Namun flag --overwrite di uber-signer v1.3.0 biasanya menimpa jika dikonfigurasi benar,
          # Tapi defaultnya dia bikin *-debugSigned.apk. Kita perlu rename balik.
          
          cd workspace
          for f in *-debugSigned.apk; do
              # Jika ada file hasil sign
              if [ -f "$f" ]; then
                  original_name="${f%-debugSigned.apk}.apk" # Hapus suffix
                  original_name="${original_name%-aligned}.apk" # Jaga-jaga ada aligned
                  mv "$f" "$original_name"
              fi
          done
          
          # Hapus sisa-sisa file unsigned jika masih ada (optional, tapi zip akan ambil semua)
          rm -f *-aligned.apk
          cd ..

      - name: Repackaging to APKS
        run: |
          echo "üì¶ Membungkus ulang menjadi .APKS..."
          cd workspace
          zip -r -q ../Patched_App.apks .
          cd ..
          
          echo "‚úÖ Selesai! File siap diupload."

      - name: Upload Hasil (APKS)
        uses: actions/upload-artifact@v4
        with:
          name: Patched_App_For_SAI
          path: Patched_App.apks
