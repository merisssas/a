name: MyXL LSPatch (Force Re-Sign & Align)

on:
  workflow_dispatch:
    inputs:
      apk_url:
        description: 'Direct Link Download MyXL (XAPK/APK)'
        required: true
        type: string

jobs:
  lspatch-process:
    runs-on: ubuntu-latest
    env:
      _JAVA_OPTIONS: "-Xmx4096m"

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Install & Prepare Tools
        run: |
          # 1. Download LSPatch (Fixed Link)
          wget https://github.com/LSPosed/LSPatch/releases/download/v0.6/jar-v0.6-398-release.jar -O lspatch.jar

          # 2. Download Modul: JustTrustMe (Stabil)
          wget https://github.com/Fuzion24/JustTrustMe/releases/download/v.2/JustTrustMe.apk -O module.apk

          # 3. Download APKEditor
          wget https://github.com/REAndroid/APKEditor/releases/download/V1.4.0/APKEditor-1.4.0.jar -O APKEditor.jar

          # 4. Download Signer
          wget https://github.com/patrickfav/uber-apk-signer/releases/download/v1.3.0/uber-apk-signer-1.3.0.jar -O signer.jar
          
          # 5. Install ZIP tool (Untuk menghapus signature lama)
          sudo apt-get update && sudo apt-get install -y zip

      - name: Download Target App
        run: |
          echo "Downloading MyXL..."
          wget "${{ inputs.apk_url }}" -O input_file
          
          if unzip -t input_file > /dev/null 2>&1; then
            echo "FILE_TYPE=XAPK" >> $GITHUB_ENV
            mv input_file raw.xapk
          else
            mv input_file raw.apk
            echo "FILE_TYPE=APK" >> $GITHUB_ENV
          fi

      - name: Merge XAPK (If needed)
        if: env.FILE_TYPE == 'XAPK'
        run: |
          echo "Extracting & Merging XAPK..."
          unzip raw.xapk -d extracted_xapk
          java -jar APKEditor.jar m -i extracted_xapk -o original.apk
          rm -rf extracted_xapk raw.xapk

      - name: Prepare APK (If needed)
        if: env.FILE_TYPE == 'APK'
        run: mv raw.apk original.apk

      - name: Execute LSPatch
        run: |
          echo "Running LSPatch..."
          mkdir -p output
          
          # Inject module JustTrustMe dan spoof signature
          java -jar lspatch.jar original.apk -m module.apk -f -o output
          
          # Rename hasil agar pasti
          find output -name "*.apk" -exec mv {} lspatched.apk \;

      - name: Force Align & Sign (The Fix)
        run: |
          echo "Removing old signature to force re-align..."
          # Hapus folder META-INF agar terlihat belum disign
          zip -d lspatched.apk META-INF/\*
          
          echo "Signing and Aligning..."
          # Sekarang signer akan terpaksa memproses file ini
          java -jar signer.jar --apks lspatched.apk --out .
          
          # Rename hasil final (output default signer ada suffix -aligned-debugSigned)
          mv lspatched-aligned-debugSigned.apk MyXL-Final-Bypass.apk

      - name: Upload Result
        uses: actions/upload-artifact@v4
        with:
          name: MyXL-Final-Bypass
          path: MyXL-Final-Bypass.apk
