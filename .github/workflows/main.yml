name: Advanced MyXL Patcher (APK-MITM)

on:
  workflow_dispatch:
    inputs:
      apk_url:
        description: 'Link Download Direct (XAPK atau APK)'
        required: true
        type: string

jobs:
  patch-process:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # 1. Setup Environment (Java untuk Merge, Node untuk Patching)
      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # 2. Install Tools yang Dibutuhkan
      - name: Install Dependencies
        run: |
          echo "Installing APK-MITM..."
          npm install -g apk-mitm

          echo "Downloading APKEditor (Best for merging XAPK)..."
          wget https://github.com/REAndroid/APKEditor/releases/download/V1.4.0/APKEditor-1.4.0.jar -O APKEditor.jar

      # 3. Download File Target
      - name: Download App
        run: |
          echo "Downloading from URL..."
          wget "${{ inputs.apk_url }}" -O input_file
          
          # Deteksi tipe file (XAPK / APK)
          if unzip -t input_file > /dev/null 2>&1; then
            echo "FILE_TYPE=XAPK" >> $GITHUB_ENV
            mv input_file raw.xapk
          else
            echo "File mungkin APK biasa atau corrupt, mencoba rename ke apk..."
            mv input_file raw.apk
            echo "FILE_TYPE=APK" >> $GITHUB_ENV
          fi

      # 4. Proses Merge (Khusus jika input adalah XAPK)
      - name: Merge XAPK to APK (If needed)
        if: env.FILE_TYPE == 'XAPK'
        run: |
          echo "Detected XAPK. Extracting..."
          unzip raw.xapk -d extracted_xapk
          
          echo "Merging Split APKs into Single APK..."
          # APKEditor 'm' command menggabungkan split config menjadi satu APK utuh
          java -jar APKEditor.jar m -i extracted_xapk -o target.apk
          
          echo "Merge Complete. Target file: target.apk"

      - name: Prepare APK (If input was already APK)
        if: env.FILE_TYPE == 'APK'
        run: |
          mv raw.apk target.apk

      # 5. EKSEKUSI APK-MITM (The Magic Step)
      - name: Run APK-MITM (Bypass SSL Pinning)
        run: |
          echo "Starting Patch Process..."
          # apk-mitm akan:
          # 1. Decode APK
          # 2. Patch Network Security Config
          # 3. Disable Certificate Pinning di code Smali
          # 4. Encode & Sign ulang
          
          apk-mitm target.apk
          
          # Hasil output default apk-mitm adalah: target-patched.apk
          if [ -f "target-patched.apk" ]; then
            echo "Patch Success!"
            mv target-patched.apk MyXL-Mod-Bypass.apk
          else
            echo "Patch Failed! Cek log di atas."
            exit 1
          fi

      # 6. Upload Hasil
      - name: Upload Result
        uses: actions/upload-artifact@v4
        with:
          name: MyXL-Bypass-Result
          path: MyXL-Mod-Bypass.apk
