name: MyXL Key Hunter (Debug Mode)

on:
  workflow_dispatch:
    inputs:
      apk_url:
        description: 'Direct Link Download APK/APKM'
        required: true

jobs:
  hunt:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Setup Java 17
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install JADX
        run: |
          wget https://github.com/skylot/jadx/releases/download/v1.4.7/jadx-1.4.7.zip
          unzip -q jadx-1.4.7.zip -d jadx
          chmod +x jadx/bin/jadx

      - name: Download & Extract
        run: |
          echo "‚¨áÔ∏è Downloading..."
          # Download sebagai zip
          wget -O downloaded_file.zip "${{ inputs.apk_url }}"
          
          echo "üìÇ Cek ukuran file:"
          ls -lh downloaded_file.zip
          
          echo "üì¶ Extracting..."
          unzip -q downloaded_file.zip -d extracted_content || echo "Unzip warning (lanjutkan saja)"
          
          echo "üîé Mencari file APK..."
          # Cari file bernama base.apk atau file .apk terbesar
          find extracted_content -name "*.apk" -ls
          
          # Logic: Cari base.apk, kalau gak ada ambil APK terbesar
          TARGET_APK=$(find extracted_content -name "base.apk" | head -n 1)
          
          if [ -z "$TARGET_APK" ]; then
             echo "‚ö†Ô∏è base.apk tidak ditemukan, mencari file APK terbesar..."
             TARGET_APK=$(find extracted_content -name "*.apk" -printf "%s %p\n" | sort -nr | head -n 1 | awk '{print $2}')
          fi
          
          if [ -z "$TARGET_APK" ]; then
             echo "‚ùå GAGAL: Tidak ada file .apk ditemukan dalam download!"
             exit 1
          fi
          
          echo "‚úÖ Target ditemukan: $TARGET_APK"
          # Rename ke target.apk di root folder agar mudah
          mv "$TARGET_APK" target_final.apk

      - name: Decompile APK (High Memory)
        run: |
          echo "üöÄ Memulai Decompile pada target_final.apk..."
          ls -lh target_final.apk
          
          # SETTING PENTING: Berikan 4GB RAM ke Java agar tidak crash
          export JAVA_OPTS="-Xmx4g"
          
          # Jalankan JADX
          # -d out: output folder
          # -r: decompile resources (strings.xml)
          # -s: decompile sources (java)
          # --no-debug-info: hemat memory
          ./jadx/bin/jadx -d out -r -s --no-debug-info target_final.apk

      - name: Verify Output
        run: |
          if [ -d "out" ]; then
            echo "‚úÖ Decompile Selesai. Cek isi folder output:"
            ls -F out/
          else
            echo "‚ùå CRITICAL: Folder 'out' tidak terbentuk. JADX Gagal."
            exit 1
          fi

      - name: Run Hunter Script
        run: |
          if [ -f "hunt.py" ]; then
            python hunt.py
          else
            echo "‚ùå Script hunt.py tidak ditemukan di repository!"
            echo "Pastikan Anda sudah upload file hunt.py"
          fi
