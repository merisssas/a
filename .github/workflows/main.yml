name: Super Patcher V2 (Fix Download)

on:
  workflow_dispatch:
    inputs:
      apk_url:
        description: 'Link Direct Download APK Target'
        required: true
        type: string

jobs:
  inject-everything:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Environment
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Tools
        run: |
          sudo apt-get update
          sudo apt-get install -y aria2
          npm install -g apk-mitm
          wget "https://github.com/LSPosed/LSPatch/releases/download/v0.6/jar-v0.6-398-release.jar" -O lspatch.jar

      - name: Download Target APK (Ultimate Fix)
        run: |
          echo "üîç Mengecek Status Link..."
          # Cek Header dulu untuk memastikan link hidup (Debug)
          curl -I "${{ inputs.apk_url }}"
          
          echo "‚¨áÔ∏è Sedang mendownload dengan Aria2..."
          
          # MENGGUNAKAN ARIA2C (Lebih kuat tembus blokir & stabil)
          # -x 16: 16 Koneksi sekaligus
          # -s 16: Split file jadi 16 bagian
          # --header: Menambahkan Referer agar dianggap browser valid
          
          aria2c -x 16 -s 16 \
            --user-agent="Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36" \
            --header="Referer: https://catbox.moe/" \
            --header="Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8" \
            --out=target.apk \
            --check-certificate=false \
            --allow-overwrite=true \
            "${{ inputs.apk_url }}" || echo "Aria2 gagal, mencoba fallback..."

          # Fallback ke Curl jika Aria2 gagal total (dengan opsi follow redirect agresif)
          if [ ! -f target.apk ] || [ $(stat -c%s "target.apk") -lt 1024 ]; then
            echo "‚ö†Ô∏è Aria2 gagal, mencoba metode Curl Fallback..."
            curl -L -k --retry 3 \
              -H "User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64)" \
              -o target.apk \
              "${{ inputs.apk_url }}"
          fi

          echo "=== Info File ==="
          ls -lh target.apk
          
          # Validasi Akhir
          if [ ! -f target.apk ]; then
             echo "‚ùå ERROR: File tidak terdownload sama sekali."
             exit 1
          fi

          FILE_SIZE=$(stat -c%s "target.apk")
          if [ "$FILE_SIZE" -lt 1024 ]; then
             echo "‚ùå ERROR FATAL: File kosong (Size: $FILE_SIZE bytes). Link Link Anda 100% Mati atau Server memblokir IP GitHub."
             exit 1
          fi

          echo "‚úÖ File Valid! Siap diproses."

      - name: Download Android Faker (Module)
        run: |
          LATEST_URL=$(curl -s https://api.github.com/repos/Android1500/AndroidFaker/releases/latest | grep "browser_download_url" | grep ".apk" | cut -d '"' -f 4)
          
          if [ -z "$LATEST_URL" ]; then
             echo "Gagal mencari Android Faker, menggunakan fallback link..."
             wget "https://github.com/Android1500/AndroidFaker/releases/download/1.2.0/AndroidFaker_1.2.0.apk" -O module.apk
          else
             echo "Download Android Faker dari: $LATEST_URL"
             wget "$LATEST_URL" -O module.apk
          fi

      - name: Tahap 1 - Patch Network (Reqable)
        run: |
          echo "Membuka Network Security Config..."
          apk-mitm target.apk --wait
          
          mv *-patched.apk step1.apk

      - name: Tahap 2 - Inject Spoofer (LSPatch)
        run: |
          echo "Menyuntikkan Module Spoofing..."
          java -jar lspatch.jar step1.apk -m module.apk -f -l
          
          OUTPUT_LSPATCH=$(find . -maxdepth 1 -type f -name "step1-*-lspatch.apk" | head -n 1)
          if [ -z "$OUTPUT_LSPATCH" ]; then
             OUTPUT_LSPATCH=$(find . -maxdepth 1 -type f -name "*-lspatch.apk" | head -n 1)
          fi
          
          mv "$OUTPUT_LSPATCH" Final_Sniff_Spoof.apk

      - name: Upload Hasil Akhir
        uses: actions/upload-artifact@v4
        with:
          name: Aplikasi-Siap-Sniff-Spoof
          path: Final_Sniff_Spoof.apk
