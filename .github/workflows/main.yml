name: Super Patcher V11 (APKS/XAPK Support + Android 15)

on:
  workflow_dispatch:
    inputs:
      apk_url:
        description: 'Link APK / APKS / XAPK (Versi Universal/32-bit)'
        required: true
        type: string
        default: 'https://www.mediafire.com/file/lxciw8l36u045wn/Mnet+Plus_3.38.0.apk/file'

jobs:
  inject-everything:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Java (Temurin 17)
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
      
      - name: Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10' 

      # Install AAPT
      - name: Install Android Tools
        run: |
          sudo apt-get update
          sudo apt-get install -y aapt

      - name: Create Certificate File
        run: |
          cat <<EOF > reqable.pem
          -----BEGIN CERTIFICATE-----
          MIIFETCCA/mgAwIBAgIUOkl2iSzmLNvVqAPLtLk5WxAWItAwDQYJKoZIhvcNAQEL
          BQAwgZUxCzAJBgNVBAYTAkNOMREwDwYDVQQIDAhTaGFuZ2hhaTERMA8GA1UEBwwI
          U2hhbmdoYWkxFTATBgNVBAoMDFJlcWFibGUsIExMQzFJMBsGA1UECwwUaHR0cHM6
          Ly9yZXFhYmxlLmNvbS8wKgYDVQQDDCNSZXFhYmxlIENBIChKYW4gMTUsIDIwMjYs
          IDBBQjIyQTI3KTAeFw0yNjAxMTUxMDAxMzJaFw0zMzA1MzEwNTU1NDZaMIGVMQsw
          CQYDVQQGEwJDTjERMA8GA1UECAwIU2hhbmdoYWkxETAPBgNVBAcMCFNoYW5naGFp
          MRUwEwYDVQQKDAxSZXFhYmxlLCBMTEMxSTAbBgNVBAsMFGh0dHBzOi8vcmVxYWJs
          ZS5jb20vMCoGA1UEAwwjUmVxYWJsZSBDQSAoSmFuIDE1LCAyMDI2LCAwQUIyMkEy
          NykwggEiMA0GCSqGSIb3DQEBAQUAA4IBDwAwggEKAoIBAQC9v7wn1vWtLg7bXddE
          CWC58lY+KDqtJINb7aOoObMMKL4sc68+KpTJVTwOsWCnrrLbzPvO5+LEKIOh10IP
          PBDTJBLU3t1OcaReQQic91Yl2MKsrFS9WbW4iRR+BeHtfRMaar+EB23aVMdwx1Uk
          WOlqt5hQaoRbUZnqpgaf+OS2PRHbMHyEPvd3e8pxMkI4V5uSBBdGpdObJuoWUUzf
          VKsgSVDDypbx3eNGKJtc04dZFi+DdGbpfynDgAyTliXbozRuvYOTi17KL1/aLM2K
          GGC1KKdFlXo7sELimlD3TZq7QCrCXdJduJ/qT+aIgrYV8ZIz0OpcXrXjBHhQwlmF
          JlgfAgMBAAGjggFVMIIBUTAdBgNVHQ4EFgQU8pGSM/80EVRYMbfHRefpv2lbZJYw
          HwYDVR0jBBgwFoAU8pGSM/80EVRYMbfHRefpv2lbZJYwDwYDVR0TAQH/BAUwAwEB
          /zAOBgNVHQ8BAf8EBAMCAgQwge0GCWCGSAGG+EIBDQSB3xaB3FRoaXMgUm9vdCBj
          ZXJ0aWZpY2F0ZSB3YXMgZ2VuZXJhdGVkIGJ5IFJlcWFibGUgUHJveHkgZm9yIFNT
          TCBQcm94eWluZy4gSWYgdGhpcyBjZXJ0aWZpY2F0ZSBpcyBwYXJ0IG9mIGEgY2Vy
          dGlmaWNhdGUgY2hhaW4sIHRoaXMgbWVhbnMgdGhhdCB5b3UncmUgYnJvd3Npbmcg
          dGhyb3VnaCBSZXFhYmxlIFByb3h5IHdpdGggU1NMIFByb3h5aW5nIGVuYWJsZWQg
          Zm9yIHRoaXMgd2Vic2l0ZS4wDQYJKoZIhvcNAQELBQADggEBAJBTF1a+EIfxOpi0
          PXhBbNq6LgSLEPFgFms6TByLmKOMgaFhkI74XttYUoe/JPnr7LNDGAZcvmGIv1nq
          5O8vvmzsq3R+moe3GfsU7XlpOnXerdXo0+aCe+KOM6emCqD7fwvKbBmjm54MsZwg
          rp3XQS1mGRirZBNkjKEtLFUdams223C98ohpue7b0CvVxEIfCzhGl4l4sKwOfMz1
          ioqA6JRC56mHKaN8uWO3vWzuEjHOdluWgRVDhtoWzf/V8LNbZHuO0G2nTQw4aNfo
          jTl712YOY5ljPgYFxjT41QEavk3/vY6gDKcX4xpZb0T2xa3QFY7cYjZcU990u66y
          Ff6Xjn0=
          -----END CERTIFICATE-----
          EOF

      - name: Install Tools
        run: |
          npm install -g apk-mitm
          wget "https://github.com/LSPosed/LSPatch/releases/download/v0.6/jar-v0.6-398-release.jar" -O lspatch.jar
          wget "https://github.com/patrickfav/uber-apk-signer/releases/download/v1.3.0/uber-apk-signer-1.3.0.jar" -O signer.jar
          pip install cloudscraper requests beautifulsoup4

      - name: Download File (APK/APKS/XAPK)
        shell: python
        env:
          APK_URL: ${{ inputs.apk_url }}
        run: |
          import cloudscraper
          import os
          import sys
          import re
          from bs4 import BeautifulSoup
          from urllib.parse import urlparse

          original_url = os.environ['APK_URL']
          url = original_url
          scraper = cloudscraper.create_scraper(browser='chrome')

          print(f"ðŸ”— Menganalisis URL: {url}")
          
          # Deteksi Ekstensi File
          filename = "input_file.apk" # Default
          if ".apks" in url:
             filename = "input_file.apks"
             print("ðŸ“¦ Tipe File: Split APKS")
          elif ".xapk" in url:
             filename = "input_file.xapk"
             print("ðŸ“¦ Tipe File: XAPK Bundle")
          
          need_scrape = False
          if 'mediafire.com' in url:
              if 'download' in urlparse(url).netloc:
                  need_scrape = False
              elif '/file/' in url:
                  need_scrape = True
              else:
                  need_scrape = True

          if need_scrape:
              try:
                  html = scraper.get(url).text
                  soup = BeautifulSoup(html, 'html.parser')
                  download_btn = soup.find('a', {'id': 'downloadButton'})
                  if download_btn and download_btn.get('href'):
                      url = download_btn.get('href')
                      if url.startswith('//'): url = 'https:' + url
                      print(f"âœ… Direct Link ditemukan: {url}")
                  else:
                      match = re.search(r'href="((https?:)?//download[^"]+)"', html)
                      if match:
                          url = match.group(1)
                          if url.startswith('//'): url = 'https:' + url
                          print(f"âœ… Direct Link (Regex) ditemukan: {url}")
                      else:
                          print("âŒ FATAL: Gagal Scrape.")
                          sys.exit(1)
              except Exception as e:
                  print(f"âŒ Error Scrape: {str(e)}")
                  sys.exit(1)

          print(f"â¬‡ï¸ Sedang mendownload ke {filename}...")
          try:
              with scraper.get(url, stream=True, timeout=60) as r:
                  if r.status_code != 200:
                      print(f"âŒ Gagal akses URL: {r.status_code}")
                      sys.exit(1)
                  total_size = int(r.headers.get('content-length', 0))
                  with open(filename, 'wb') as f:
                      dl_size = 0
                      for chunk in r.iter_content(chunk_size=1024*1024): 
                          if chunk:
                              f.write(chunk)
                              dl_size += len(chunk)
                              if total_size > 0 and dl_size % (10 * 1024 * 1024) == 0:
                                  print(f"   ... {dl_size/1024/1024:.2f} MB")
                  print(f"âœ… Download Selesai. Total: {dl_size/1024/1024:.2f} MB")
                  if dl_size < 1048576: 
                      print("âŒ ERROR: File < 1MB.")
                      sys.exit(1)
          except Exception as e:
              print(f"âŒ Download Gagal: {str(e)}")
              sys.exit(1)

      - name: Download Android Faker
        run: |
          LATEST_URL=$(curl -s https://api.github.com/repos/Android1500/AndroidFaker/releases/latest | grep "browser_download_url" | grep ".apk" | cut -d '"' -f 4)
          if [ -z "$LATEST_URL" ]; then
             wget "https://github.com/Android1500/AndroidFaker/releases/download/1.2.0/AndroidFaker_1.2.0.apk" -O module.apk
          else
             wget "$LATEST_URL" -O module.apk
          fi

      - name: Tahap 1 - Auto Merge & Patch Network (Reqable)
        run: |
          echo "Membuka & Menggabungkan (jika APKS)..."
          
          # Cari file input apapun ekstensinya
          INPUT_FILE=$(ls input_file.* | head -n 1)
          echo "Memproses file: $INPUT_FILE"
          
          # apk-mitm akan otomatis merge APKS/XAPK jadi satu file APK
          apk-mitm "$INPUT_FILE" --certificate reqable.pem
          
          # Cari hasil patch (biasanya berakhiran -patched.apk)
          PATCHED_FILE=$(find . -maxdepth 1 -type f -name "*-patched.apk" | head -n 1)
          
          if [ -z "$PATCHED_FILE" ]; then
             echo "âŒ Gagal Patch / Merge APKS!"
             exit 1
          fi
          
          echo "âœ… Sukses Merge & Patch! Rename ke step1.apk"
          mv "$PATCHED_FILE" step1.apk

      - name: Check Architecture (Post-Merge)
        run: |
          echo "ðŸ” Cek Arsitektur APK Hasil Merge..."
          ARCH_INFO=$(aapt dump badging step1.apk | grep "native-code")
          echo "ðŸ“‹ $ARCH_INFO"
          
          if [[ "$ARCH_INFO" == *"arm64"* ]] && [[ "$ARCH_INFO" != *"armeabi-v7a"* ]]; then
            echo "âš ï¸ PERINGATAN: Hasil merge ini 64-bit ONLY. Realme Note 50 mungkin menolak install."
          elif [[ "$ARCH_INFO" == *"armeabi-v7a"* ]]; then
            echo "âœ… Aman: Library 32-bit terdeteksi."
          fi

      - name: Tahap 2 - Inject Spoofer (LSPatch)
        run: |
          java -jar lspatch.jar step1.apk -m module.apk -f -l 2
          
          OUTPUT_LSPATCH=$(find . -maxdepth 1 -type f -name "*-lspatched.apk" | head -n 1)
          if [ -z "$OUTPUT_LSPATCH" ]; then
             OUTPUT_LSPATCH=$(ls -t *.apk | grep -v "step1.apk" | grep -v "module.apk" | grep -v "input_file" | head -n 1)
          fi
          
          if [ -z "$OUTPUT_LSPATCH" ]; then
             echo "âŒ Gagal patch LSPatch!"
             exit 1
          fi
          mv "$OUTPUT_LSPATCH" unsigned_final.apk

      - name: Tahap 3 - Final Signing (Android 15 Fix)
        run: |
          java -jar signer.jar --apks unsigned_final.apk
          
          FINAL_APK=$(find . -maxdepth 1 -type f -name "*-aligned-debugSigned.apk" | head -n 1)
          mv "$FINAL_APK" "Final_Patched_App.apk"

      - name: Upload Hasil Akhir
        uses: actions/upload-artifact@v4
        with:
          name: Final_Patched_App
          path: Final_Patched_App.apk
