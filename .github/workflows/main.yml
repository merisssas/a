      - name: Patch AndroidManifest & Stealth Cleanup
        run: |
          python3 -c "
          import re
          import os
          import shutil

          # Konfigurasi Path
          decompiled_dir = 'decompiled_app'
          manifest_path = os.path.join(decompiled_dir, 'AndroidManifest.xml')
          apktool_yml = os.path.join(decompiled_dir, 'apktool.yml')

          # 1. ANTI-DETECTION: Hapus jejak Apktool (Sangat Penting!)
          # Banyak app mengecek keberadaan file ini untuk mendeteksi modifikasi.
          if os.path.exists(apktool_yml):
              os.remove(apktool_yml)
              print('[Stealth] apktool.yml removed (Anti-tamper bypass #1).')
          else:
              print('[Info] apktool.yml not found.')

          # 2. PATCH MANIFEST
          if os.path.exists(manifest_path):
              with open(manifest_path, 'r') as f:
                  content = f.read()

              # A. Inject Network Security Config (Tanpa merusak struktur)
              if 'android:networkSecurityConfig' in content:
                  print('[Info] Config already exists. Skipping inject.')
              else:
                  # Kita gunakan regex yang lebih rapi
                  content = re.sub(r'(<application)', r'\1 android:networkSecurityConfig=\"@xml/network_security_config\"', content, count=1)
                  print('[Patch] Injected networkSecurityConfig.')

              # B. Fix Native Libs (Wajib untuk XAPK/Split APK)
              if 'android:extractNativeLibs' in content:
                  content = re.sub(r'android:extractNativeLibs=\"false\"', r'android:extractNativeLibs=\"true\"', content)
                  print('[Fix] Updated extractNativeLibs to true.')
              else:
                  content = re.sub(r'(<application)', r'\1 android:extractNativeLibs=\"true\"', content, count=1)
                  print('[Patch] Injected extractNativeLibs=true.')
              
              # C. Enable Cleartext Traffic (Jaga-jaga untuk HTTP non-SSL)
              if 'android:usesCleartextTraffic' not in content:
                  content = re.sub(r'(<application)', r'\1 android:usesCleartextTraffic=\"true\"', content, count=1)
                  print('[Patch] Injected usesCleartextTraffic=true.')

              # D. STEALTH: JANGAN inject android:debuggable="true"
              # App production akan menolak jalan jika debuggable=true. 
              # Kita hapus flag debuggable jika ada (biar seolah-olah release build)
              if 'android:debuggable=\"true\"' in content:
                  content = content.replace('android:debuggable=\"true\"', 'android:debuggable=\"false\"')
                  print('[Stealth] Removed debuggable flag to mimic release build.')

              with open(manifest_path, 'w') as f:
                  f.write(content)
              print('[Success] AndroidManifest.xml patched with stealth method.')
          else:
              print('[Error] AndroidManifest.xml not found!')
              exit(1)
          "
