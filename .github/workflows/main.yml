name: Super Patcher V2 (Fix Download)

on:
  workflow_dispatch:
    inputs:
      apk_url:
        description: 'Link Direct Download APK Target'
        required: true
        type: string

jobs:
  inject-everything:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Java (Temurin 17)
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
      
      - name: Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # [BARU] Setup Python untuk Downloader Canggih
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10' 

      - name: Install Tools & Dependencies
        run: |
          # Install tool patcher
          npm install -g apk-mitm
          wget "https://github.com/LSPosed/LSPatch/releases/download/v0.6/jar-v0.6-398-release.jar" -O lspatch.jar
          
          # Install library Python anti-blokir
          pip install cloudscraper requests

      # [SOLUSI UTAMA] Menggunakan Python Cloudscraper untuk download
      - name: Download Target APK (Python Anti-Block)
        shell: python
        env:
          APK_URL: ${{ inputs.apk_url }}
        run: |
          import cloudscraper
          import sys
          import os

          url = os.environ['APK_URL']
          print(f"üöÄ Memulai download dari: {url}")

          # Inisialisasi Scraper sebagai Chrome Browser (Bypass Cloudflare/WAF)
          scraper = cloudscraper.create_scraper(browser='chrome')

          try:
              # Download dengan stream untuk menangani file besar
              # Timeout 60 detik untuk koneksi awal
              with scraper.get(url, stream=True, timeout=60) as r:
                  
                  # Cek jika status bukan 200 OK
                  if r.status_code != 200:
                      print(f"‚ùå Server menolak akses. Status Code: {r.status_code}")
                      sys.exit(1)
                  
                  # Cek Header Size
                  content_len = r.headers.get('content-length')
                  if content_len:
                      print(f"‚ÑπÔ∏è Ukuran File dari Header: {int(content_len) / 1024 / 1024:.2f} MB")
                  else:
                      print("‚ÑπÔ∏è Server tidak mengirim info ukuran file (Chunked download).")

                  # Proses penulisan file
                  with open('target.apk', 'wb') as f:
                      total_downloaded = 0
                      for chunk in r.iter_content(chunk_size=1024*1024): # 1MB chunks
                          if chunk:
                              f.write(chunk)
                              total_downloaded += len(chunk)
                  
                  print(f"‚úÖ Download Selesai. Total tersimpan di disk: {total_downloaded} bytes")
                  
                  # Validasi Ukuran (Minimal 100KB agar dianggap APK valid)
                  if total_downloaded < 102400:
                      print("‚ùå ERROR FATAL: File terlalu kecil (< 100KB). Kemungkinan IP GitHub diblokir total oleh file hosting.")
                      sys.exit(1)

          except Exception as e:
              print(f"‚ùå Script Error: {str(e)}")
              sys.exit(1)

      - name: Cek & Validasi File
        run: |
          ls -lh target.apk
          echo "File valid. Lanjut ke patching..."

      - name: Download Android Faker (Module)
        run: |
          # Menggunakan curl biasa untuk GitHub (GitHub API aman dari blokir)
          LATEST_URL=$(curl -s https://api.github.com/repos/Android1500/AndroidFaker/releases/latest | grep "browser_download_url" | grep ".apk" | cut -d '"' -f 4)
          
          if [ -z "$LATEST_URL" ]; then
             echo "Fallback link..."
             wget "https://github.com/Android1500/AndroidFaker/releases/download/1.2.0/AndroidFaker_1.2.0.apk" -O module.apk
          else
             echo "Download dari: $LATEST_URL"
             wget "$LATEST_URL" -O module.apk
          fi

      - name: Tahap 1 - Patch Network (Reqable)
        run: |
          echo "Membuka Network Security Config..."
          apk-mitm target.apk --wait
          
          # Rename hasil patch agar konsisten
          mv *-patched.apk step1.apk

      - name: Tahap 2 - Inject Spoofer (LSPatch)
        run: |
          echo "Menyuntikkan Module Spoofing..."
          java -jar lspatch.jar step1.apk -m module.apk -f -l
          
          OUTPUT_LSPATCH=$(find . -maxdepth 1 -type f -name "step1-*-lspatch.apk" | head -n 1)
          if [ -z "$OUTPUT_LSPATCH" ]; then
             OUTPUT_LSPATCH=$(find . -maxdepth 1 -type f -name "*-lspatch.apk" | head -n 1)
          fi
          
          mv "$OUTPUT_LSPATCH" Final_Sniff_Spoof.apk

      - name: Upload Hasil Akhir
        uses: actions/upload-artifact@v4
        with:
          name: Aplikasi-Siap-Sniff-Spoof
          path: Final_Sniff_Spoof.apk
