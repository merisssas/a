name: MyXL LSPatch (Signature Spoof + SSL Bypass)

on:
  workflow_dispatch:
    inputs:
      apk_url:
        description: 'Direct Link Download MyXL (XAPK/APK)'
        required: true
        type: string

jobs:
  lspatch-process:
    runs-on: ubuntu-latest
    env:
      _JAVA_OPTIONS: "-Xmx4096m"

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Install & Prepare Tools
        run: |
          # 1. Download LSPatch (Tool inti untuk inject module)
          echo "Downloading LSPatch..."
          wget https://github.com/LSPosed/LSPatch/releases/download/v0.6/lspatch.jar -O lspatch.jar

          # 2. Download Modul SSL Unpinning (TrustMeAlready - Paling Ampuh)
          echo "Downloading TrustMeAlready Module..."
          wget https://github.com/ViRb3/TrustMeAlready/releases/download/v1.11/TrustMeAlready-v1.11-release.apk -O module.apk

          # 3. Download APKEditor (Untuk Merge XAPK)
          echo "Downloading APKEditor..."
          wget https://github.com/REAndroid/APKEditor/releases/download/V1.4.0/APKEditor-1.4.0.jar -O APKEditor.jar

      - name: Download Target App
        run: |
          echo "Downloading MyXL..."
          wget "${{ inputs.apk_url }}" -O input_file
          
          if unzip -t input_file > /dev/null 2>&1; then
            echo "FILE_TYPE=XAPK" >> $GITHUB_ENV
            mv input_file raw.xapk
          else
            mv input_file raw.apk
            echo "FILE_TYPE=APK" >> $GITHUB_ENV
          fi

      - name: Merge XAPK (If needed)
        if: env.FILE_TYPE == 'XAPK'
        run: |
          echo "Extracting & Merging XAPK..."
          unzip raw.xapk -d extracted_xapk
          java -jar APKEditor.jar m -i extracted_xapk -o original.apk
          rm -rf extracted_xapk raw.xapk

      - name: Prepare APK (If needed)
        if: env.FILE_TYPE == 'APK'
        run: mv raw.apk original.apk

      - name: Execute LSPatch (The Fix)
        run: |
          echo "Running LSPatch..."
          mkdir -p output
          
          # Syntax: java -jar lspatch.jar [target] -m [module] -f (force) -o [output_dir]
          # LSPatch secara otomatis mempertahankan Signature Asli (Spoofing)
          java -jar lspatch.jar original.apk -m module.apk -f -o output
          
          # Rename hasil output
          find output -name "*.apk" -exec mv {} MyXL-LSPatch-Bypass.apk \;
          
          if [ -f "MyXL-LSPatch-Bypass.apk" ]; then
             echo "LSPatch Success!"
          else
             echo "LSPatch Failed!"
             exit 1
          fi

      - name: Upload Result
        uses: actions/upload-artifact@v4
        with:
          name: MyXL-LSPatch-Result
          path: MyXL-LSPatch-Bypass.apk
